local utf8 = {}
local textViewer = require("/FrOS/sys/textViewer")

local utf8_cp1252 = {
    [0xE282AC] = 0x80, [0xE2809A] = 0x82, [0xC692] = 0x83, [0xE2809E] = 0x84,
    [0xE280A6] = 0x85, [0xE280A0] = 0x86, [0xE280A1] = 0x87, [0xCB86] = 0x88,
    [0xE280B0] = 0x89, [0xC5A0] = 0x8A, [0xE280B9] = 0x8B, [0xC592] = 0x8C,
    [0xC5BD] = 0x8E, [0xE28098] = 0x91, [0xE28099] = 0x92, [0xE2809C] = 0x93,
    [0xE2809D] = 0x94, [0xE280A2] = 0x95, [0xE28093] = 0x96, [0xE28094] = 0x97,
    [0xCB9C] = 0x98, [0xE284A2] = 0x99, [0xC5A1] = 0x9A, [0xE280BA] = 0x9B,
    [0xC593] = 0x9C, [0xC5BE] = 0x9E, [0xC5B8] = 0x9F, [0xC2A0] = 0xA0,
    [0xC2A1] = 0xA1, [0xC2A2] = 0xA2, [0xC2A3] = 0xA3, [0xC2A4] = 0xA4,
    [0xC2A5] = 0xA5, [0xC2A6] = 0xA6, [0xC2A7] = 0xA7, [0xC2A8] = 0xA8,
    [0xC2A9] = 0xA9, [0xC2AA] = 0xAA, [0xC2AB] = 0xAB, [0xC2AC] = 0xAC,
    [0xC2AD] = 0xAD, [0xC2AE] = 0xAE, [0xC2AF] = 0xAF, [0xC2B0] = 0xB0,
    [0xC2B1] = 0xB1, [0xC2B2] = 0xB2, [0xC2B3] = 0xB3, [0xC2B4] = 0xB4,
    [0xC2B5] = 0xB5, [0xC2B6] = 0xB6, [0xC2B7] = 0xB7, [0xC2B8] = 0xB8,
    [0xC2B9] = 0xB9, [0xC2BA] = 0xBA, [0xC2BB] = 0xBB, [0xC2BC] = 0xBC,
    [0xC2BD] = 0xBD, [0xC2BE] = 0xBE, [0xC2BF] = 0xBF, [0xC380] = 0xC0,
    [0xC381] = 0xC1, [0xC382] = 0xC2, [0xC383] = 0xC3, [0xC384] = 0xC4,
    [0xC385] = 0xC5, [0xC386] = 0xC6, [0xC387] = 0xC7, [0xC388] = 0xC8,
    [0xC389] = 0xC9, [0xC38A] = 0xCA, [0xC38B] = 0xCB, [0xC38C] = 0xCC,
    [0xC38D] = 0xCD, [0xC38E] = 0xCE, [0xC38F] = 0xCF, [0xC390] = 0xD0,
    [0xC391] = 0xD1, [0xC392] = 0xD2, [0xC393] = 0xD3, [0xC394] = 0xD4,
    [0xC395] = 0xD5, [0xC396] = 0xD6, [0xC397] = 0xD7, [0xC398] = 0xD8,
    [0xC399] = 0xD9, [0xC39A] = 0xDA, [0xC39B] = 0xDB, [0xC39C] = 0xDC,
    [0xC39D] = 0xDD, [0xC39E] = 0xDE, [0xC39F] = 0xDF, [0xC3A0] = 0xE0,
    [0xC3A1] = 0xE1, [0xC3A2] = 0xE2, [0xC3A3] = 0xE3, [0xC3A4] = 0xE4,
    [0xC3A5] = 0xE5, [0xC3A6] = 0xE6, [0xC3A7] = 0xE7, [0xC3A8] = 0xE8,
    [0xC3A9] = 0xE9, [0xC3AA] = 0xEA, [0xC3AB] = 0xEB, [0xC3AC] = 0xEC,
    [0xC3AD] = 0xED, [0xC3AE] = 0xEE, [0xC3AF] = 0xEF, [0xC3B0] = 0xF0,
    [0xC3B1] = 0xF1, [0xC3B2] = 0xF2, [0xC3B3] = 0xF3, [0xC3B4] = 0xF4,
    [0xC3B5] = 0xF5, [0xC3B6] = 0xF6, [0xC3B7] = 0xF7, [0xC3B8] = 0xF8,
    [0xC3B9] = 0xF9, [0xC3BA] = 0xFA, [0xC3BB] = 0xFB, [0xC3BC] = 0xFC,
    [0xC3BD] = 0xFD, [0xC3BE] = 0xFE, [0xC3BF] = 0xFF
}

local cp1252_utf8 = {}
for utf8val, cp in pairs(utf8_cp1252) do
    local bytes = {}
    local tmp = utf8val
    local octets = {}
    while tmp > 0 do
        table.insert(octets, 1, tmp % 256)
        tmp = math.floor(tmp / 256)
    end
    for _, b in ipairs(octets) do
        table.insert(bytes, string.char(b))
    end
    cp1252_utf8[cp] = table.concat(bytes)
end

function utf8.tocp1252(str)
    local out = {}
    local i = 1
    while i <= #str do
        local c = str:byte(i)

        local len = 1
        if c >= 0xF0 then len = 4
        elseif c >= 0xE0 then len = 3
        elseif c >= 0xC0 then len = 2
        end

        local bytes = {str:byte(i, i+len-1)}
        local val = 0
        for _, b in ipairs(bytes) do
            val = val * 256 + b
        end

        if utf8_cp1252[val] then
            table.insert(out, string.char(utf8_cp1252[val]))
        elseif c < 0x80 then
            table.insert(out, string.char(c))
        else
            table.insert(out, "?")
        end

        i = i + len
    end
    return table.concat(out)
end

function utf8.toutf8(str)
    local out = {}
    for i = 1, #str do
        local b = str:byte(i)
        if b < 0x80 then
            table.insert(out, string.char(b))
        elseif cp1252_utf8[b] then
            table.insert(out, cp1252_utf8[b])
        else
            table.insert(out, "?")
        end
    end
    return table.concat(out)
end

return utf8